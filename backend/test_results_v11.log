============================= test session starts ==============================
platform darwin -- Python 3.14.0, pytest-8.0.2, pluggy-1.6.0 -- /Library/Frameworks/Python.framework/Versions/3.14/bin/python3
cachedir: .pytest_cache
rootdir: /Users/galindoasc/keikichi_logistics_web/backend
plugins: asyncio-0.23.8, anyio-4.12.0
asyncio: mode=Mode.STRICT
collecting ... collected 18 items

tests/test_system_flows.py::TestSystemFlows::test_1_health_check PASSED  [  5%]
tests/test_system_flows.py::TestSystemFlows::test_2_register_client PASSED [ 11%]
tests/test_system_flows.py::TestSystemFlows::test_3_login_client PASSED  [ 16%]
tests/test_system_flows.py::TestSystemFlows::test_4_get_me PASSED        [ 22%]
tests/test_system_flows.py::TestSystemFlows::test_5_update_profile PASSED [ 27%]
tests/test_system_flows.py::TestSystemFlows::test_6_create_trip FAILED   [ 33%]
tests/test_system_flows.py::TestSystemFlows::test_7_list_trips PASSED    [ 38%]
tests/test_system_flows.py::TestSystemFlows::test_8_get_trip_detail FAILED [ 44%]
tests/test_system_flows.py::TestSystemFlows::test_9_update_trip_status FAILED [ 50%]
tests/test_system_flows.py::TestSystemFlows::test_10_bulk_delete_trips_logic_check FAILED [ 55%]
tests/test_system_flows.py::TestSystemFlows::test_11_create_reservation FAILED [ 61%]
tests/test_system_flows.py::TestSystemFlows::test_12_cancel_reservation FAILED [ 66%]
tests/test_system_flows.py::TestSystemFlows::test_13_admin_list_reservations PASSED [ 72%]
tests/test_system_flows.py::TestSystemFlows::test_14_delete_reservation FAILED [ 77%]
tests/test_system_flows.py::TestSystemFlows::test_15_get_system_config PASSED [ 83%]
tests/test_system_flows.py::TestSystemFlows::test_16_update_exchange_rate PASSED [ 88%]
tests/test_system_flows.py::TestSystemFlows::test_17_upload_document PASSED [ 94%]
tests/test_system_flows.py::TestSystemFlows::test_18_list_my_documents PASSED [100%]
tests/test_system_flows.py::TestSystemFlows::test_18_list_my_documents ERROR [100%]

==================================== ERRORS ====================================
________ ERROR at teardown of TestSystemFlows.test_18_list_my_documents ________

self = <sqlalchemy.engine.base.Connection object at 0x110ffc8c0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10fd42490>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x110439a90>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteDDLCompiler object at 0x11093c690>
parameters = [()]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-1, started daemon 6111080448)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.IntegrityError: FOREIGN KEY constraint failed

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: IntegrityError

The above exception was the direct cause of the following exception:

    def finalizer() -> None:
        """Yield again, to finalize."""
    
        async def async_finalizer() -> None:
            try:
                await gen_obj.__anext__()
            except StopAsyncIteration:
                pass
            else:
                msg = "Async generator fixture didn't stop."
                msg += "Yield only once."
                raise ValueError(msg)
    
>       event_loop.run_until_complete(async_finalizer())

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:345: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/asyncio/base_events.py:719: in run_until_complete
    return future.result()
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:337: in async_finalizer
    await gen_obj.__anext__()
tests/conftest.py:80: in setup_database
    await conn.run_sync(Base.metadata.drop_all)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/engine.py:888: in run_sync
    return await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/schema.py:5956: in drop_all
    bind._run_ddl_visitor(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2459: in _run_ddl_visitor
    ).traverse_single(element)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/visitors.py:661: in traverse_single
    return meth(obj, **kw)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/ddl.py:1142: in visit_metadata
    self.traverse_single(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/visitors.py:661: in traverse_single
    return meth(obj, **kw)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/ddl.py:1209: in visit_table
    DropTable(table)._invoke_with(self.connection)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/ddl.py:321: in _invoke_with
    return bind.execute(self)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/ddl.py:187: in _execute_on_connection
    return connection._execute_ddl(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1530: in _execute_ddl
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-1, started daemon 6111080448)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) FOREIGN KEY constraint failed
E               [SQL: 
E               DROP TABLE users]
E               (Background on this error at: https://sqlalche.me/e/20/gkpj)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: IntegrityError
=================================== FAILURES ===================================
______________________ TestSystemFlows.test_6_create_trip ______________________

self = <sqlalchemy.engine.base.Connection object at 0x1101bbd40>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x110062ed0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x10ffddae0>
client = <httpx.AsyncClient object at 0x11010eb10>
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjUsInR5cGUiOiJhY2Nlc3MifQ.AQblOZwbPbeAOp26WQsi8mAdKti97yEb_6DQIcT4G6w'

    async def test_6_create_trip(self, client: AsyncClient, admin_token):
        trip_data = {
            "origin": "Test City A",
            "destination": "Test City B",
            "departure_date": "2025-12-25",
            "price_per_space": 1000.0,
            "currency": "MXN",
            "total_spaces": 10,
            "is_international": False
        }
>       response = await client.post("/api/v1/trips",
            headers={"Authorization": f"Bearer {admin_token}"},
            json=trip_data
        )

tests/test_system_flows.py:72: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
---------------------------- Captured stdout setup -----------------------------
2025-12-08 23:56:05,715 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:05,715 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:05,715 INFO sqlalchemy.engine.Engine [cached since 0.6897s ago] ('superadmin', 'manager')
2025-12-08 23:56:05,715 INFO sqlalchemy.engine.Engine ROLLBACK
Failed to notify admins: (sqlite3.OperationalError) no such table: users
[SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?]
[parameters: ('superadmin', 'manager')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
------------------------------ Captured log setup ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.6897s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:05,889 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:05,889 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:05,889 INFO sqlalchemy.engine.Engine [cached since 0.8635s ago] ('superadmin', 'manager')
2025-12-08 23:56:05,889 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 0.8635s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
____________________ TestSystemFlows.test_8_get_trip_detail ____________________

self = <sqlalchemy.engine.base.Connection object at 0x11039de50>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x1104384d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x10fff6050>
client = <httpx.AsyncClient object at 0x1103597b0>
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjYsInR5cGUiOiJhY2Nlc3MifQ.sFDVMtYVTfOvnEKEO5yegRunI23jp9Qj9c4O2JhkcNU'

    async def test_8_get_trip_detail(self, client: AsyncClient, admin_token):
        # We need a trip ID. We can create one or rely on fixture.
        # Implementing a quick helper inside the test class might be messy.
        # Ideally, we'd use a fixture, but let's create one inline for clarity/isolation.
>       response = await client.post("/api/v1/trips",
            headers={"Authorization": f"Bearer {admin_token}"},
            json={
                "origin": "Detail Test",
                "destination": "City",
                "departure_date": "2025-01-01",
                "price_per_space": 500,
                "currency": "USD",
                "total_spaces": 10
            }
        )

tests/test_system_flows.py:92: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:06,450 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:06,450 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:06,450 INFO sqlalchemy.engine.Engine [cached since 1.425s ago] ('superadmin', 'manager')
2025-12-08 23:56:06,450 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.425s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
__________________ TestSystemFlows.test_9_update_trip_status ___________________

self = <sqlalchemy.engine.base.Connection object at 0x11039f890>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x1104390d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x10fff6250>
client = <httpx.AsyncClient object at 0x1103a6450>
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjYsInR5cGUiOiJhY2Nlc3MifQ.sFDVMtYVTfOvnEKEO5yegRunI23jp9Qj9c4O2JhkcNU'

    async def test_9_update_trip_status(self, client: AsyncClient, admin_token):
        # Create
>       res = await client.post("/api/v1/trips", headers={"Authorization": f"Bearer {admin_token}"}, json={
            "origin": "Status Test", "destination": "City", "departure_date": "2025-01-01", "price_per_space": 500, "total_spaces": 10
        })

tests/test_system_flows.py:111: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:06,788 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:06,788 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:06,788 INFO sqlalchemy.engine.Engine [cached since 1.763s ago] ('superadmin', 'manager')
2025-12-08 23:56:06,789 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 1.763s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
____________ TestSystemFlows.test_10_bulk_delete_trips_logic_check _____________

self = <sqlalchemy.engine.base.Connection object at 0x110497110>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x11043b1d0>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x10ffe7a70>
client = <httpx.AsyncClient object at 0x110475c50>
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjcsInR5cGUiOiJhY2Nlc3MifQ.GA4Y1P3RXplj77diSyOrV5d2eJpoFGq6s9HKeOIgLHQ'

    async def test_10_bulk_delete_trips_logic_check(self, client: AsyncClient, admin_token):
        # Create 3 trips
        ids = []
        for i in range(3):
>           res = await client.post("/api/v1/trips", headers={"Authorization": f"Bearer {admin_token}"}, json={
                "origin": f"Bulk {i}", "destination": "Dest", "departure_date": "2025-01-01", "price_per_space": 100, "total_spaces": 10
            })

tests/test_system_flows.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:07,142 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:07,142 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:07,142 INFO sqlalchemy.engine.Engine [cached since 2.117s ago] ('superadmin', 'manager')
2025-12-08 23:56:07,142 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 2.117s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
__________________ TestSystemFlows.test_11_create_reservation __________________

self = <sqlalchemy.engine.base.Connection object at 0x1104507d0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x11043b650>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x10ffe7d40>
client = <httpx.AsyncClient object at 0x1104956d0>
user_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4ZGNiZGY5MS04NTI0LTQ1YTEtYWUxYS1jZjNkNDYxNWZiMDQiLCJleHAiOjE3NjUyNjg3NjcsInR5cGUiOiJhY2Nlc3MifQ.xh4keFKFhGbUaoQpsl00AqHmpf7F1BAAa3JSs1iYNFk'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjcsInR5cGUiOiJhY2Nlc3MifQ.GA4Y1P3RXplj77diSyOrV5d2eJpoFGq6s9HKeOIgLHQ'

    async def test_11_create_reservation(self, client: AsyncClient, user_token, admin_token):
        # Need a trip first
>       trip_res = await client.post("/api/v1/trips", headers={"Authorization": f"Bearer {admin_token}"}, json={
            "origin": "Res Test", "destination": "City", "departure_date": "2025-01-01", "price_per_space": 100, "total_spaces": 10
        })

tests/test_system_flows.py:147: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:07,659 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:07,659 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:07,659 INFO sqlalchemy.engine.Engine [cached since 2.634s ago] ('superadmin', 'manager')
2025-12-08 23:56:07,660 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 2.634s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
__________________ TestSystemFlows.test_12_cancel_reservation __________________

self = <sqlalchemy.engine.base.Connection object at 0x1104536b0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x11043bf50>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x11012e6d0>
client = <httpx.AsyncClient object at 0x110453d40>
user_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4ZGNiZGY5MS04NTI0LTQ1YTEtYWUxYS1jZjNkNDYxNWZiMDQiLCJleHAiOjE3NjUyNjg3NjcsInR5cGUiOiJhY2Nlc3MifQ.xh4keFKFhGbUaoQpsl00AqHmpf7F1BAAa3JSs1iYNFk'
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjgsInR5cGUiOiJhY2Nlc3MifQ.5Tz0261JjZeyfYI0cbEzK4dV26OSnyIDk8nP3ICIDLU'

    async def test_12_cancel_reservation(self, client: AsyncClient, user_token, admin_token):
        # Setup trip and reservation
>       trip_res = await client.post("/api/v1/trips", headers={"Authorization": f"Bearer {admin_token}"}, json={
            "origin": "Res Cancel", "destination": "City", "departure_date": "2025-01-01", "price_per_space": 100, "total_spaces": 10
        })

tests/test_system_flows.py:165: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:08,162 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:08,162 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:08,162 INFO sqlalchemy.engine.Engine [cached since 3.137s ago] ('superadmin', 'manager')
2025-12-08 23:56:08,162 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 3.137s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
__________________ TestSystemFlows.test_14_delete_reservation __________________

self = <sqlalchemy.engine.base.Connection object at 0x1109e64e0>
dialect = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteDialect_aiosqlite object at 0x10db09550>
context = <sqlalchemy.dialects.sqlite.aiosqlite.SQLiteExecutionContext_aiosqlite object at 0x110439b50>
statement = <sqlalchemy.dialects.sqlite.base.SQLiteCompiler object at 0x11034d250>
parameters = [('superadmin', 'manager')]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlite3.OperationalError: no such table: users

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError

The above exception was the direct cause of the following exception:

self = <test_system_flows.TestSystemFlows object at 0x1100f3ad0>
client = <httpx.AsyncClient object at 0x11043d8d0>
admin_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4OTJiMDU4NC04ZWFkLTQ5MWItYWIxMi00MjE0NWIxYWY5NTkiLCJleHAiOjE3NjUyNjg3NjgsInR5cGUiOiJhY2Nlc3MifQ.5Tz0261JjZeyfYI0cbEzK4dV26OSnyIDk8nP3ICIDLU'
user_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI4ZGNiZGY5MS04NTI0LTQ1YTEtYWUxYS1jZjNkNDYxNWZiMDQiLCJleHAiOjE3NjUyNjg3NjgsInR5cGUiOiJhY2Nlc3MifQ.CqpPUJ9kC_4VuW8jVpmqrQNoJ4U4FJ3YfmAhciUYkqg'

    async def test_14_delete_reservation(self, client: AsyncClient, admin_token, user_token):
         # Create
>       trip_res = await client.post("/api/v1/trips", headers={"Authorization": f"Bearer {admin_token}"}, json={
            "origin": "Res Del", "destination": "City", "departure_date": "2025-01-01", "price_per_space": 100, "total_spaces": 10
        })

tests/test_system_flows.py:186: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1877: in post
    return await self.request(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1559: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1646: in send
    response = await self._send_handling_auth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1674: in _send_handling_auth
    response = await self._send_handling_redirects(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1711: in _send_handling_redirects
    response = await self._send_single_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_client.py:1748: in _send_single_request
    response = await transport.handle_async_request(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/httpx/_transports/asgi.py:162: in handle_async_request
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:758: in __call__
    await self.middleware_stack(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:778: in app
    await route.handle(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:299: in handle
    await self.app(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:79: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:64: in wrapped_app
    raise exc
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    await app(scope, receive, sender)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/routing.py:74: in app
    response = await func(request)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:299: in app
    raise e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:294: in app
    raw_response = await run_endpoint_function(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
app/api/v1/trips.py:54: in create_trip
    await notification_service.notify_trip_created(trip, admins_only=False)
app/services/notification_service.py:218: in notify_trip_created
    await self.notify_admins(title, message, link, "info")
app/services/notification_service.py:396: in notify_admins
    result = await db.execute(query)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1419: in execute
    return meth(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/sql/elements.py:526: in _execute_on_connection
    return connection._execute_clauseelement(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/engine/default.py:951: in do_execute
    cursor.execute(statement, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:340: in _handle_exception
    raise error
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:122: in _execute
    return await future
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Connection(Thread-2, started daemon 6127906816)>

    def run(self) -> None:
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = self._tx.get()
            if tx_item is _STOP_RUNNING_SENTINEL:
                break
    
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
E               sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: users
E               [SQL: SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
E               FROM users 
E               WHERE users.role = ? OR users.role = ?]
E               [parameters: ('superadmin', 'manager')]
E               (Background on this error at: https://sqlalche.me/e/20/e3q8)

/Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/aiosqlite/core.py:105: OperationalError
----------------------------- Captured stdout call -----------------------------
2025-12-08 23:56:08,840 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-08 23:56:08,840 INFO sqlalchemy.engine.Engine SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
2025-12-08 23:56:08,840 INFO sqlalchemy.engine.Engine [cached since 3.815s ago] ('superadmin', 'manager')
2025-12-08 23:56:08,840 INFO sqlalchemy.engine.Engine ROLLBACK
------------------------------ Captured log call -------------------------------
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT users.id, users.email, users.phone, users.hashed_password, users.full_name, users.role, users.is_active, users.is_verified, users.verification_status, users.ine_front_file_id, users.ine_back_file_id, users.ine_selfie_file_id, users.verification_notes, users.verified_at, users.verified_by, users.rejection_reason, users.billing_name, users.billing_address, users.billing_rfc, users.billing_email, users.billing_phone, users.billing_cfdi_usage, users.constancia_file_id, users.created_at, users.updated_at 
FROM users 
WHERE users.role = ? OR users.role = ?
INFO     sqlalchemy.engine.Engine:base.py:1846 [cached since 3.815s ago] ('superadmin', 'manager')
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
=============================== warnings summary ===============================
app/schemas/auth.py:45
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/auth.py:45: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserOut(BaseModel):

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:211: 273 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/routing.py:211: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    is_coroutine = asyncio.iscoroutinefunction(dependant.call)

app/schemas/user.py:9
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/user.py:9: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserBase(BaseModel):

app/schemas/user.py:31
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/user.py:31: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserResponse(UserBase):

app/schemas/user.py:77
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/user.py:77: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator('email', 'phone')

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi_mail/schemas.py:91
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi_mail/schemas.py:91: PydanticDeprecatedSince212: Using `@model_validator` with mode='after' on a classmethod is deprecated. Instead, use an instance method. See the documentation at https://docs.pydantic.dev/2.12/concepts/validators/#model-after-validator. Deprecated in Pydantic V2.12 to be removed in V3.0.
    @model_validator(mode="after")

app/schemas/trip.py:70
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/trip.py:70: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class TripOut(TripBase):

app/schemas/space.py:10
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/space.py:10: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SpaceBase(BaseModel):

app/schemas/reservation.py:27
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:27: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class HoldSpacesResponse(BaseModel):

app/schemas/reservation.py:64
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:64: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LoadItemResponse(LoadItemCreate):

app/schemas/reservation.py:152
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:152: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReservationSpaceDetail(BaseModel):

app/schemas/reservation.py:162
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:162: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReservationTripDetail(BaseModel):

app/schemas/reservation.py:178
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:178: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReservationResponse(BaseModel):

app/schemas/reservation.py:243
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/reservation.py:243: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReservationListItem(BaseModel):

app/schemas/label_price.py:18
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/label_price.py:18: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class LabelPriceOut(LabelPriceBase):

app/api/v1/system_config.py:28
  /Users/galindoasc/keikichi_logistics_web/backend/app/api/v1/system_config.py:28: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SystemConfigResponse(SystemConfigBase):

app/schemas/client_document.py:24
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/client_document.py:24: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ClientDocumentOut(ClientDocumentBase):

app/schemas/catalog.py:17
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/catalog.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Product(ProductBase):

app/schemas/catalog.py:35
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/catalog.py:35: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Unit(UnitBase):

app/schemas/notification.py:25
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/notification.py:25: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NotificationResponse(NotificationBase):

app/schemas/fleet.py:22
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/fleet.py:22: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FleetDriverOut(FleetDriverBase):

app/schemas/fleet.py:49
  /Users/galindoasc/keikichi_logistics_web/backend/app/schemas/fleet.py:49: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class FleetVehicleOut(FleetVehicleBase):

app/main.py:42
  /Users/galindoasc/keikichi_logistics_web/backend/app/main.py:42: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495
../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

app/main.py:82
  /Users/galindoasc/keikichi_logistics_web/backend/app/main.py:82: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:169: 599 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:169: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    return asyncio.iscoroutinefunction(obj) or inspect.isasyncgenfunction(obj)

../../../../Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:433: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:433: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    return asyncio.iscoroutinefunction(func)

tests/test_system_flows.py::TestSystemFlows::test_1_health_check
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:1005: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    return asyncio.get_event_loop_policy()

tests/test_system_flows.py::TestSystemFlows::test_1_health_check
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:662: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    old_loop_policy = asyncio.get_event_loop_policy()

tests/test_system_flows.py::TestSystemFlows::test_1_health_check
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:667: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
    asyncio.set_event_loop_policy(policy)

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:751: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    _restore_event_loop_policy(asyncio.get_event_loop_policy()),

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:977: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
    asyncio.set_event_loop_policy(new_loop_policy)

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:978: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    loop = asyncio.get_event_loop_policy().new_event_loop()

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:766: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    policy = asyncio.get_event_loop_policy()

tests/test_system_flows.py: 39 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/starlette/_utils.py:42: DeprecationWarning: 'asyncio.iscoroutinefunction' is deprecated and slated for removal in Python 3.16; use inspect.iscoroutinefunction() instead
    return asyncio.iscoroutinefunction(obj) or (

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:811: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    policy = asyncio.get_event_loop_policy()

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:835: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
    asyncio.set_event_loop_policy(previous_policy)

tests/test_system_flows.py: 18 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:847: DeprecationWarning: 'asyncio.get_event_loop_policy' is deprecated and slated for removal in Python 3.16
    policy = asyncio.get_event_loop_policy()

tests/test_system_flows.py: 13 warnings
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/jose/jwt.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = timegm(datetime.utcnow().utctimetuple())

tests/test_system_flows.py::TestSystemFlows::test_7_list_trips
  /Users/galindoasc/keikichi_logistics_web/backend/app/api/v1/trips.py:24: PydanticDeprecatedSince20: The `from_orm` method is deprecated; set `model_config['from_attributes']=True` and use `model_validate` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    TripOut.from_orm(trip).model_copy(update={

tests/test_system_flows.py::TestSystemFlows::test_18_list_my_documents
  <sys>:0: SAWarning: Can't sort tables for DROP; an unresolvable foreign key dependency exists between tables: client_documents, reservations, trips, users; and backend does not support ALTER.  To restore at least a partial sort, apply use_alter=True to ForeignKey and ForeignKeyConstraint objects involved in the cycle to mark these as known cycles that will be ignored.

tests/test_system_flows.py::TestSystemFlows::test_18_list_my_documents
  /Library/Frameworks/Python.framework/Versions/3.14/lib/python3.14/site-packages/pytest_asyncio/plugin.py:671: DeprecationWarning: 'asyncio.set_event_loop_policy' is deprecated and slated for removal in Python 3.16
    asyncio.set_event_loop_policy(old_loop_policy)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_system_flows.py::TestSystemFlows::test_6_create_trip - sqla...
FAILED tests/test_system_flows.py::TestSystemFlows::test_8_get_trip_detail - ...
FAILED tests/test_system_flows.py::TestSystemFlows::test_9_update_trip_status
FAILED tests/test_system_flows.py::TestSystemFlows::test_10_bulk_delete_trips_logic_check
FAILED tests/test_system_flows.py::TestSystemFlows::test_11_create_reservation
FAILED tests/test_system_flows.py::TestSystemFlows::test_12_cancel_reservation
FAILED tests/test_system_flows.py::TestSystemFlows::test_14_delete_reservation
ERROR tests/test_system_flows.py::TestSystemFlows::test_18_list_my_documents
============= 7 failed, 11 passed, 1099 warnings, 1 error in 5.06s =============
